<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Fam√≠lia 100K ‚Äì Painel do Don</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />

  <!-- libs (Painel usa fetch, Desafio usa supabase-js + Chart.js) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }

    body {
      margin: 0;
      padding: 0;
      background: #000 url('don.jpg') center/cover no-repeat fixed;
      color: #f9fafb;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: -1;
    }

    .container { max-width: 1000px; margin: 0 auto; padding: 24px 16px 40px; }
    header { margin-bottom: 18px; text-align: center; }
    header h1 { margin: 0; font-size: 2.4rem; font-weight: 800; letter-spacing: 0.08em; text-transform: uppercase; }
    header h1 span.gold { color: #fbbf24; }
    header p { margin: 8px 0 0; opacity: 0.9; font-size: 0.95rem; }
    .tagline { margin-top: 8px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.14em; opacity: 0.7; }

    /* ===== Tabs (PAINEL / DESAFIO) ===== */
    .tabs {
      display:flex;
      justify-content:center;
      gap:10px;
      margin: 14px 0 18px;
      flex-wrap: wrap;
    }
    .tab-btn {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 999px;
      padding: 10px 16px;
      background: rgba(10, 15, 25, 0.85);
      color: #e5e7eb;
      font-weight: 800;
      letter-spacing: .06em;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
      transition: transform .08s ease, opacity .08s ease;
    }
    .tab-btn:active { transform: translateY(1px) scale(.99); opacity:.95; }
    .tab-btn.active {
      background: linear-gradient(90deg, rgba(185,28,28,.95), rgba(249,115,22,.95));
      border-color: rgba(251,191,36,0.55);
      color: #fff;
    }

    /* ===== Cards base ===== */
    .cards-grid { display: grid; grid-template-columns: minmax(0, 1fr); gap: 16px; }
    .card {
      background: rgba(10, 15, 25, 0.94);
      border-radius: 18px;
      padding: 18px 16px 16px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      box-shadow: 0 18px 40px rgba(0,0,0,0.8);
      backdrop-filter: blur(14px);
    }
    .card h2 { margin: 0 0 10px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
    .card h2 span.emoji { font-size: 1.25rem; }

    label { font-size: 0.8rem; opacity: 0.9; display: block; margin-bottom: 4px; }
    input[type="number"], input[type="text"] {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 8px 10px;
      background: #020617;
      color: #f9fafb;
      font-size: 0.95rem;
      outline: none;
    }
    input[type="text"]::placeholder { color: rgba(148, 163, 184, 0.7); }
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 6px 8px;
      background: #020617;
      color: #f9fafb;
      font-size: 0.82rem;
      outline: none;
      resize: vertical;
      min-height: 48px;
    }
    textarea::placeholder { color: rgba(148, 163, 184, 0.7); }

    .row { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 10px; }
    .row .col { flex: 1 1 200px; }
    .helper-text { font-size: 0.8rem; opacity: 0.7; margin-top: 4px; }

    .progress-wrapper { margin-top: 10px; }
    .progress-label { display: flex; justify-content: space-between; font-size: 0.8rem; opacity: 0.9; margin-bottom: 4px; }
    .progress-bar-bg {
      width: 100%;
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, #020617, #020617);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.45);
    }
    .progress-bar-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #b91c1c, #f97316, #fbbf24);
      transition: width 0.3s ease-out;
    }

    .level-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(148, 163, 184,0.15), rgba(251, 191, 36, 0.12));
      border: 1px solid rgba(251, 191, 36, 0.7);
      font-size: 0.78rem;
      margin-top: 8px;
    }
    .level-chip span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #fbbf24;
      box-shadow: 0 0 10px rgba(251,191,36,0.9);
    }
    .sub-label { font-size: 0.76rem; opacity: 0.75; margin-top: 2px; }

    .save-feedback { margin-top: 6px; font-size: 0.78rem; opacity: 0; transition: opacity 0.2s ease-out; }
    .save-feedback.visible { opacity: 0.9; }

    .checkpoints-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px; margin-top: 8px; }
    .checkpoint { border-radius: 12px; padding: 8px 10px; background: rgba(15,23,42,0.96); border: 1px solid rgba(148, 163, 184, 0.55); font-size: 0.78rem; }
    .checkpoint-title { font-weight: 600; margin-bottom: 4px; font-size: 0.8rem; }
    .checkpoint-status { font-size: 0.75rem; display: flex; align-items: center; gap: 4px; }
    .cp-unlocked { border-color: rgba(34,197,94,0.95); box-shadow: 0 0 12px rgba(22,163,74,0.38); }
    .cp-unlocked .checkpoint-status { color: #4ade80; }
    .cp-next { border-color: rgba(251,191,36,0.95); box-shadow: 0 0 12px rgba(251,191,36,0.3); }
    .cp-next .checkpoint-status { color: #facc15; }
    .cp-locked .checkpoint-status { color: rgba(148,163,184,0.85); }

    .missions-list { display: flex; flex-direction: column; gap: 8px; margin-top: 4px; }
    .mission-row { display: flex; flex-direction: column; gap: 6px; padding: 6px 8px; border-radius: 10px; background: rgba(15,23,42,0.8); border: 1px solid rgba(148,163,184,0.3); }
    .mission-header { display: flex; align-items: center; gap: 8px; font-size: 0.78rem; opacity: 0.9; }
    .mission-header input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
    .mission-header span { flex: 1; }
    .mission-row textarea { margin-top: 2px; }
    .mission-row.done { border-color: rgba(34,197,94,0.9); background: rgba(5,46,22,0.95); opacity: 0.97; }
    .mission-row.done textarea { text-decoration: line-through; opacity: 0.9; }

    .btn-row { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
    button {
      border: none;
      padding: 8px 12px;
      border-radius: 999px;
      background: linear-gradient(90deg, #b91c1c, #f97316);
      color: #f9fafb;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
      box-shadow: 0 10px 25px rgba(0,0,0,0.7);
    }
    button.secondary {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
    }
    button:active { transform: translateY(1px) scale(0.99); box-shadow: 0 4px 12px rgba(0,0,0,0.7); opacity: 0.95; }

    .cards-rewards { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 8px; }
    .reward-card {
      border-radius: 14px;
      padding: 10px;
      background: radial-gradient(circle at top, #111827 0, #020617 80%);
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 0.78rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      position: relative;
    }
    .reward-title { font-weight: 600; font-size: 0.82rem; }
    .reward-tag { font-size: 0.7rem; opacity: 0.8; }
    .reward-quote { font-size: 0.72rem; opacity: 0.8; margin-top: 2px; font-style: italic; }
    .reward-status { margin-top: 4px; font-size: 0.75rem; display: flex; align-items: center; gap: 4px; }
    .reward-unlocked { border-color: rgba(34,197,94,0.95); box-shadow: 0 0 12px rgba(22,163,74,0.35); }
    .reward-unlocked .reward-status { color: #4ade80; }
    .reward-locked .reward-status { color: rgba(148,163,184,0.85); }
    .reward-unlocked .reward-title { color: #fbbf24; }

    footer { margin-top: 22px; font-size: 0.78rem; opacity: 0.6; text-align: center; }

    /* MODAL DA CARTA */
    .reward-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .reward-modal.open { display: flex; }
    .reward-modal-inner {
      position: relative;
      width: min(360px, 90%);
      padding: 16px;
      border-radius: 20px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.98) 0, rgba(2,6,23,0.98) 80%);
      border: 1px solid rgba(251,191,36,0.7);
      box-shadow: 0 30px 80px rgba(0,0,0,0.9);
      overflow: hidden;
    }
    .reward-modal-inner::before {
      content: "";
      position: absolute;
      inset: 0;
      background: url('don.jpg') center/cover no-repeat;
      opacity: 0.14;
      filter: grayscale(100%);
      z-index: -1;
    }
    .reward-modal-title { font-size: 1rem; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .reward-modal-tag { font-size: 0.78rem; opacity: 0.85; margin-bottom: 10px; }
    .reward-modal-quote { font-size: 0.86rem; font-style: italic; margin-bottom: 10px; }
    .reward-modal-desc { font-size: 0.8rem; opacity: 0.9; margin-bottom: 12px; }
    .reward-modal-footer { font-size: 0.72rem; opacity: 0.8; text-align: right; }
    .reward-modal-close {
      position: absolute;
      top: 8px;
      right: 8px;
      border: none;
      border-radius: 999px;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.7);
    }
    .reward-modal-close:hover { background: rgba(30,64,175,0.9); }

    /* ===== DESAFIO (scoped) ===== */
    #secDesafio .muted { opacity: .75; font-size: .82rem; }
    #secDesafio .desafio-top {
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom: 12px;
    }
    #secDesafio .desafio-actions { display:flex; gap:10px; flex-wrap:wrap; }
    #secDesafio .desafio-actions .d-btn {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(10,15,25,.85);
      color: #e5e7eb;
      font-weight: 800;
      cursor:pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,.6);
    }
    #secDesafio .desafio-actions .d-btn.primary {
      background: linear-gradient(90deg, rgba(37,99,235,.95), rgba(14,165,233,.85));
      border-color: rgba(59,130,246,.35);
      color:#fff;
    }
    #secDesafio .desafio-actions .d-btn.danger {
      background: linear-gradient(90deg, rgba(220,38,38,.95), rgba(249,115,22,.9));
      border-color: rgba(249,115,22,.35);
      color:#fff;
    }

    #secDesafio .d-grid {
      display:grid;
      grid-template-columns: 1.1fr 2fr 1.1fr;
      gap: 14px;
      align-items: start;
    }
    #secDesafio .d-panel { padding:16px; border-radius:18px; background: rgba(10, 15, 25, 0.94); border: 1px solid rgba(148, 163, 184, 0.28); box-shadow: 0 18px 40px rgba(0,0,0,0.75); }
    #secDesafio .kpi { border-radius:14px; padding:12px; background: rgba(15,23,42,.72); border: 1px solid rgba(148,163,184,.25); display:flex; justify-content:space-between; align-items:flex-end; }
    #secDesafio .kpi .v { font-weight: 900; font-size: 1.6rem; }
    #secDesafio .kpi .l { font-size:.8rem; opacity:.85; }
    #secDesafio .kpi-col { display:flex; flex-direction:column; gap:10px; }
    #secDesafio .badge {
      margin-top: 10px;
      display:inline-flex; gap:8px; align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(16,185,129,.15);
      border: 1px solid rgba(16,185,129,.35);
      font-weight:800;
    }
    #secDesafio .badge .dot { width:10px; height:10px; border-radius:999px; background:#10b981; box-shadow: 0 0 12px rgba(16,185,129,.6); }

    #secDesafio .rings {
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    #secDesafio .ringCard {
      border-radius: 18px;
      padding: 14px;
      background: rgba(10, 15, 25, 0.94);
      border: 1px solid rgba(148, 163, 184, 0.28);
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    #secDesafio .ringMeta .t { font-size:.74rem; opacity:.8; letter-spacing:.08em; text-transform:uppercase; }
    #secDesafio .ringMeta .b { font-size:1.15rem; font-weight:900; margin-top:4px; }
    #secDesafio .chartCard {
      border-radius: 18px;
      padding: 14px;
      background: rgba(10, 15, 25, 0.94);
      border: 1px solid rgba(148, 163, 184, 0.28);
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
    }
    #secDesafio .chartTitle { display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px; }
    #secDesafio .days {
      display:grid;
      grid-template-columns: repeat(18, 1fr);
      gap: 6px;
      margin-top: 12px;
    }
    #secDesafio .day {
      height: 28px;
      border-radius: 8px;
      background: rgba(15,23,42,.75);
      border: 1px solid rgba(148,163,184,.18);
      display:flex; align-items:center; justify-content:center;
      font-size: .75rem;
      cursor:pointer;
      user-select:none;
    }
    #secDesafio .g { background: rgba(34,197,94,.85); color:#04140a; border-color: rgba(34,197,94,.35); }
    #secDesafio .y { background: rgba(251,191,36,.92); color:#111827; border-color: rgba(251,191,36,.35); }
    #secDesafio .r { background: rgba(239,68,68,.90); color:#111827; border-color: rgba(239,68,68,.35); }

    /* modal desafio */
    #secDesafio .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.75);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 60;
      padding: 14px;
    }
    #secDesafio .modal-box {
      width: min(420px, 100%);
      border-radius: 18px;
      padding: 16px;
      background: rgba(10,15,25,.96);
      border: 1px solid rgba(148,163,184,.30);
      box-shadow: 0 30px 90px rgba(0,0,0,.85);
      position: relative;
    }
    #secDesafio .closeBtn {
      position:absolute;
      top:10px;
      right:10px;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(15,23,42,.85);
      color:#e5e7eb;
      cursor:pointer;
      font-size: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #secDesafio .stars span { font-size: 22px; cursor:pointer; }
    #secDesafio #note {
      margin-top: 10px;
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(2,6,23,.95);
      color: #fff;
      outline:none;
    }
    #secDesafio .modal-actions { margin-top: 14px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    #secDesafio .m-btn {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.30);
      background: rgba(15,23,42,.85);
      color:#e5e7eb;
      font-weight:900;
      cursor:pointer;
    }
    #secDesafio .m-btn.primary { background: linear-gradient(90deg, rgba(37,99,235,.95), rgba(14,165,233,.85)); color:#fff; border-color: rgba(59,130,246,.35); }
    #secDesafio .m-btn.danger  { background: linear-gradient(90deg, rgba(220,38,38,.95), rgba(249,115,22,.9)); color:#fff; border-color: rgba(249,115,22,.35); }

    /* mobile */
    @media (max-width: 1100px){
      #secDesafio .d-grid { grid-template-columns: 1fr; }
      #secDesafio .rings { grid-template-columns: 1fr 1fr; }
      #secDesafio .days { grid-template-columns: repeat(9, 1fr); }
    }
    @media (max-width: 520px){
      header h1 { font-size: 1.9rem; }
      #secDesafio .rings { grid-template-columns: 1fr; }
      #secDesafio .days { grid-template-columns: repeat(6, 1fr); }
      .tab-btn { width: 100%; }
      #secDesafio .desafio-actions .d-btn { width: 100%; }
    }
    /* seu CSS inteiro aqui... */

  /* === FIX alinhamento dos rings no desktop === */
  #secDesafio .ringCard{
    overflow: hidden;
    align-items: center;
  }

  #secDesafio .ringCard canvas{
    width: 84px !important;
    height: 84px !important;
    display: block;
  }

  #secDesafio .rings > .ringCard{
    min-width: 0;
  }
    /* Centraliza conte√∫do interno dos cards */
#secDesafio .ringCard{
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 6px;
}

/* Garante alinhamento horizontal dos rings */
#secDesafio .rings{
  display: flex;
  align-items: center;
  justify-content: space-between;
}

  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><span class="gold">Fam√≠lia</span> 100K</h1>
      <p>Painel reservado do Don para acompanhar a renda da fam√≠lia at√© os R$ 100.000 por m√™s.</p>
      <div class="tagline">ningu√©m fora da fam√≠lia v√™ isso</div>
    </header>

    <!-- ABAS -->
    <div class="tabs">
      <button class="tab-btn active" id="tabPainel" onclick="showSection('painel')">PAINEL</button>
      <button class="tab-btn" id="tabDesafio" onclick="showSection('desafio')">DESAFIO</button>
    </div>

    <!-- ========== SE√á√ÉO: PAINEL (original) ========== -->
    <section id="secPainel">
      <div class="cards-grid">
        <!-- Status -->
        <section class="card">
          <h2><span class="emoji">ü¶Ö</span>Status da fam√≠lia</h2>

          <div class="row">
            <div class="col">
              <label for="targetIncome">Meta de renda da fam√≠lia (R$/m√™s)</label>
              <input type="number" id="targetIncome" min="0" step="1000" />
              <div class="helper-text">Por padr√£o: 100000. A cifra que coloca o Don em outro patamar.</div>
            </div>

            <div class="col">
              <label for="currentIncome">Tributo atual da fam√≠lia (R$/m√™s)</label>
              <input type="number" id="currentIncome" min="0" step="500" />
              <div class="helper-text">Tudo que entra limpo hoje. Sem maquiagem, s√≥ a verdade pro Don.</div>
            </div>
          </div>

          <div class="progress-wrapper">
            <div class="progress-label">
              <span id="progressText">0% do caminho</span>
              <span id="progressValues">R$ 0 / R$ 100.000</span>
            </div>
            <div class="progress-bar-bg">
              <div class="progress-bar-fill" id="progressBarMain"></div>
            </div>
          </div>

          <div class="level-chip" id="levelChip">
            <span class="dot"></span>
            <span id="levelName">Soldado em in√≠cio de carreira</span>
          </div>
          <div class="sub-label" id="levelDescription">
            Ainda √© cedo. Voc√™ est√° montando a base, escolhendo suas guerras e alian√ßas.
          </div>

          <div id="saveFeedback" class="save-feedback"></div>

          <div class="btn-row">
            <button id="saveFinance">Salvar progresso</button>
            <button id="resetFinance" class="secondary">Zerar registros</button>
          </div>
        </section>

        <!-- Miss√µes ve√≠culo 10K -->
        <section class="card">
          <h2><span class="emoji">üíº</span>Miss√µes do ve√≠culo de 10K</h2>
          <p class="helper-text">
            Fase atual: descobrir e validar um novo ve√≠culo que possa, sozinho, gerar 10‚Äì30K/m√™s como complemento.
            Nada de escalar √† for√ßa o neg√≥cio atual. Aqui √© MVP, teste e valida√ß√£o.
          </p>

          <div class="missions-list" id="missionsList"></div>

          <div id="missionsFeedback" class="save-feedback"></div>

          <div class="btn-row">
            <button id="saveMissions">Registrar miss√µes</button>
            <button id="resetMissions" class="secondary">Limpar tudo</button>
          </div>
        </section>
      </div>

      <!-- Checkpoints -->
      <section class="card" style="margin-top:16px;">
        <h2><span class="emoji">üìà</span>Checkpoints de respeito na pra√ßa</h2>
        <p class="helper-text">
          Cada cifra √© um ponto de n√£o-retorno. Passou dali, o padr√£o de jogo do Don n√£o volta mais para tr√°s.
        </p>
        <div class="checkpoints-list" id="checkpointsList"></div>
      </section>

      <!-- Cartas -->
      <section class="card" style="margin-top:12px;">
        <h2><span class="emoji">üé¥</span>Cartas do Don</h2>
        <p class="helper-text">
          Cada checkpoint de renda desbloqueia uma carta. N√£o √© s√≥ dinheiro: √© identidade, respeito e calibre mental.
          Clique em uma carta desbloqueada para ver o recado do Don.
        </p>
        <div class="cards-rewards" id="rewardsList"></div>
        <div id="rewardsFeedback" class="save-feedback"></div>
      </section>

      <footer>
        Este painel existe para que o Brian de hoje pense como Don da pr√≥pria fam√≠lia de 100K/m√™s.
        O resto do mundo chama de sorte; aqui dentro, de estrat√©gia.
      </footer>
    </section>

    <!-- ========== SE√á√ÉO: DESAFIO (embutido) ========== -->
    <section id="secDesafio" style="display:none;">
      <div class="desafio-top">
        <div>
          <h2 style="margin:0 0 6px;">Desafio 180 Dias</h2>
          <div class="muted">Sem desculpas, sem procrastinacao, apenas fazer o que deve ser feito!</div>
        </div>

        <div class="desafio-actions">
          <button class="d-btn primary" onclick="openToday()">MARCAR HOJE</button>
        </div>
      </div>

      <div class="d-grid">
        <!-- left -->
        <div class="d-panel">
          <div style="font-weight:900; letter-spacing:.08em; opacity:.85; margin-bottom:10px;">RESUMO</div>

          <div class="kpi-col">
            <div class="kpi"><div class="l">Dia atual</div><div class="v" id="dayNow">‚Äì</div></div>
            <div class="kpi"><div class="l">Dias verdes (4‚Äì5)</div><div class="v" id="greens">‚Äì</div></div>
            <div class="kpi"><div class="l">Streak cria√ß√£o</div><div class="v" id="streak">‚Äì</div></div>
          </div>

          <div class="badge" id="badgeStatus" style="display:none;">
            <span class="dot"></span>
            <span id="badgeText">Elite em execu√ß√£o</span>
          </div>
        </div>

        <!-- middle -->
        <div>
          <div class="rings">
            <div class="ringCard">
              <div class="ringMeta"><div class="t">Momentum</div><div class="b" id="momenTxt">‚Äì</div></div>
              <div style="width:84px;height:84px;"><canvas id="ringMomentum"></canvas></div>
            </div>

            <div class="ringCard">
              <div class="ringMeta"><div class="t">Progresso</div><div class="b" id="progTxt">‚Äì</div></div>
              <div style="width:84px;height:84px;"><canvas id="ringProgress"></canvas></div>
            </div>

            <div class="ringCard">
              <div class="ringMeta"><div class="t">Qualidade</div><div class="b" id="qualTxt">‚Äì</div></div>
              <div style="width:84px;height:84px;"><canvas id="ringQuality"></canvas></div>
            </div>

            <div class="ringCard">
              <div class="ringMeta"><div class="t">Execu√ß√£o</div><div class="b" id="execTxt">‚Äì</div></div>
              <div style="width:84px;height:84px;"><canvas id="ringExec"></canvas></div>
            </div>
          </div>

          <div class="chartCard">
            <div class="chartTitle">
              <div style="font-weight:900; font-size:1.05rem;">Daily Progress</div>
              <div class="muted">score por dia (1‚Äì5)</div>
            </div>
            <canvas id="lineScores" height="120"></canvas>

            <div style="margin-top:14px; font-weight:900; font-size:1.02rem;">Hist√≥rico</div>
            <div class="days" id="grid"></div>
          </div>
        </div>

        <!-- right -->
        <div class="d-panel">
          <div style="font-weight:900; letter-spacing:.08em; opacity:.85; margin-bottom:10px;">TOP STATS</div>

          <div class="kpi-col">
            <div class="kpi"><div class="l">Dias marcados</div><div class="v" id="daysMarked">‚Äì</div></div>
            <div class="kpi"><div class="l">M√©dia score</div><div class="v" id="avgScore">‚Äì</div></div>
            <div class="kpi"><div class="l">Verde %</div><div class="v" id="greenPct">‚Äì</div></div>
            <div class="kpi"><div class="l">Criei algo %</div><div class="v" id="createPct">‚Äì</div></div>
          </div>
        </div>
      </div>

      <!-- MODAL (Desafio) -->
      <div class="modal" id="modal">
        <div class="modal-box">
          <button class="closeBtn" onclick="closeModal()">√ó</button>
          <h3 id="modalTitle" style="margin:0 0 4px;"></h3>
          <div class="muted" id="modalDate" style="margin:6px 0 10px;"></div>

          <div class="stars" id="stars" style="margin-bottom:10px;"></div>

          <label style="display:flex; gap:8px; align-items:center; margin:10px 0 8px;">
            <input type="checkbox" id="did_create">
            Criei algo hoje
          </label>

          <input id="note" placeholder="O que eu criei?">

          <div class="modal-actions">
            <button class="m-btn danger" onclick="clearDay()">Apagar este dia</button>
            <button class="m-btn primary" onclick="saveDay()">Salvar</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- MODAL DA CARTA (Painel) -->
  <div id="rewardModal" class="reward-modal">
    <div class="reward-modal-inner">
      <button class="reward-modal-close" id="closeRewardModal">&times;</button>
      <div class="reward-modal-title" id="modalRewardTitle">Carta do Don</div>
      <div class="reward-modal-tag" id="modalRewardTag"></div>
      <div class="reward-modal-quote" id="modalRewardQuote"></div>
      <div class="reward-modal-desc" id="modalRewardDesc"></div>
      <div class="reward-modal-footer">
        Esta carta s√≥ aparece para quem cruzou esse n√≠vel de respeito.
      </div>
    </div>
  </div>

  <script>
    /* ========= CONFIGURAR AQUI ========= */
    const SUPABASE_URL = "https://zocynwaideygqrofguhy.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable__oUfIDejQtH-_3W9iNJgcw_J-8YdXjO";
    const SUPABASE_TABLE = "painel_don";
    const SUPABASE_ROW_ID = 1;
    /* =================================== */

    /* =========================
       PAINEL (SEU C√ìDIGO ORIGINAL)
       ========================= */
    const STORAGE_KEYS = {
      targetIncome: "brian_mafia_target_income_v1",
      currentIncome: "brian_mafia_current_income_v1",
      missions: "brian_mafia_missions_vehicle10k_v1",
      maxIncomeEver: "brian_mafia_max_income_ever_v1",
      rewardsNotified: "brian_mafia_rewards_notified_v1"
    };

    const checkpointValues = [5000, 10000, 20000, 40000, 60000, 80000, 100000];

    const rewards = [
      { value: 5000, title: "Carta Disciplina Fria", tag: "Checkpoint 5K/m√™s", quote: "O homem que n√£o domina seus h√°bitos nunca vai dominar uma pra√ßa.", desc: "Chegar a 5K/m√™s prova que voc√™ saiu do improviso. Agora √© sobre n√£o voltar para baixo disso nunca mais." },
      { value: 10000, title: "Carta Consist√™ncia Letal", tag: "Checkpoint 10K/m√™s", quote: "N√£o √© o golpe forte. √â o golpe que nunca para de acertar.", desc: "10K/m√™s √© o primeiro n√≠vel em que o mundo come√ßa a notar que voc√™ n√£o √© mais amador. Aqui voc√™ decide se √© fogo de palha ou perman√™ncia." },
      { value: 20000, title: "Carta Vis√£o de Don", tag: "Checkpoint 20K/m√™s", quote: "Quem s√≥ olha o dia de hoje, morre pobre. Quem enxerga 10 anos, escolhe as guerras certas.", desc: "Em 20K/m√™s voc√™ n√£o est√° s√≥ ganhando mais. Voc√™ come√ßa a comprar tempo, paz mental e posi√ß√£o na mesa." },
      { value: 40000, title: "Carta Dom√≠nio da Pra√ßa", tag: "Checkpoint 40K/m√™s", quote: "Quando o dinheiro te obedece, voc√™ para de correr atr√°s de migalha.", desc: "40K/m√™s √© quando suas decis√µes ecoam na sua fam√≠lia, n√£o mais s√≥ em voc√™. Erros doem mais. Acertos tamb√©m." },
      { value: 60000, title: "Carta Mente Blindada", tag: "Checkpoint 60K/m√™s", quote: "Metade da riqueza √© n√£o se sabotar quando tudo come√ßa a dar certo.", desc: "Chegar aqui exige mais cabe√ßa do que talento. Quem n√£o sabe ficar rico em sil√™ncio, volta r√°pido pro zero." },
      { value: 80000, title: "Carta Tempo √© Moeda", tag: "Checkpoint 80K/m√™s", quote: "O homem rico de verdade compra tempo, n√£o brinquedo.", desc: "80K/m√™s mostra que voc√™ tem op√ß√£o. Agora cada sim errado custa caro demais. Tempo vira seu ativo principal." },
      { value: 100000, title: "Carta Don da Fam√≠lia", tag: "Checkpoint 100K/m√™s", quote: "Voc√™ n√£o corre mais atr√°s do dinheiro. Ele circula em torno das suas decis√µes.", desc: "100K/m√™s fecha um ciclo. N√£o √© fim de jogo. √â o come√ßo de um jogo onde voc√™ escolhe em que mundos quer jogar." }
    ];

    function formatCurrency(value) {
      if (isNaN(value)) value = 0;
      return value.toLocaleString("pt-BR", { style: "currency", currency: "BRL", maximumFractionDigits: 0 });
    }
    function clamp(value, min, max) { return Math.min(Math.max(value, min), max); }

    function getLevel(percent) {
      if (percent >= 100) return { name: "Don da fam√≠lia 100K", description: "Voc√™ assumiu o topo. Agora o jogo √© proteger, simplificar e multiplicar sem chamar aten√ß√£o errada." };
      if (percent >= 75) return { name: "Underboss em opera√ß√£o", description: "J√° existe estrutura, fluxo de caixa e respeito. As decis√µes agora s√£o cir√∫rgicas." };
      if (percent >= 50) return { name: "Consigliere em ascens√£o", description: "Voc√™ entende o jogo, enxerga os riscos e sabe onde n√£o mexer. Falta volume." };
      if (percent >= 25) return { name: "Capo com territ√≥rio", description: "Voc√™ domina um peda√ßo da pra√ßa. O foco √© aumentar margem e cortar ru√≠do." };
      if (percent > 0)  return { name: "Soldado em movimento", description: "Voc√™ saiu da teoria e entrou em campo. Sua arma √© consist√™ncia, n√£o pressa." };
      return { name: "Soldado em in√≠cio de carreira", description: "Ainda √© cedo. Voc√™ est√° montando a base, escolhendo suas guerras e alian√ßas." };
    }

    function showFeedback(elementId, message) {
      const el = document.getElementById(elementId);
      if (!el) return;
      el.textContent = message;
      el.classList.add("visible");
      setTimeout(() => el.classList.remove("visible"), 2300);
    }

    function defaultMissions() {
      return [
        { text: "Listar 3 ve√≠culos de neg√≥cio escal√°veis que fazem sentido pra mim (modelo, ticket, margem).", done: false },
        { text: "Escolher 1 ve√≠culo e definir um MVP simples para validar (oferta m√≠nima, p√°gina simples, tr√°fego de teste).", done: false },
        { text: "Rodar 1 teste real (an√∫ncio/campanha) e registrar n√∫meros: cliques, leads, vendas, percep√ß√£o de potencial.", done: false }
      ];
    }

    function loadMissionsLocal() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.missions);
        if (!raw) return defaultMissions();
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || parsed.length !== 3) return defaultMissions();
        return parsed.map(m => ({ text: typeof m.text === "string" ? m.text : "", done: !!m.done }));
      } catch { return defaultMissions(); }
    }

    function renderMissions() {
      const container = document.getElementById("missionsList");
      container.innerHTML = "";
      const missions = loadMissionsLocal();

      missions.forEach((mission, index) => {
        const row = document.createElement("div");
        row.className = "mission-row" + (mission.done ? " done" : "");
        row.dataset.index = String(index);

        const header = document.createElement("div");
        header.className = "mission-header";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = mission.done;

        const label = document.createElement("span");
        label.textContent = `Miss√£o ${index + 1}`;

        header.appendChild(checkbox);
        header.appendChild(label);

        const textarea = document.createElement("textarea");
        textarea.value = mission.text;
        textarea.placeholder = `Descreva a miss√£o ${index + 1}...`;

        checkbox.addEventListener("change", () => {
          mission.done = checkbox.checked;
          if (mission.done) row.classList.add("done");
          else row.classList.remove("done");
        });

        textarea.addEventListener("input", () => { mission.text = textarea.value; });

        row.appendChild(header);
        row.appendChild(textarea);
        container.appendChild(row);
      });

      container.dataset.missions = JSON.stringify(missions);
    }

    function buildCheckpoints() {
      const container = document.getElementById("checkpointsList");
      container.innerHTML = "";
      checkpointValues.forEach(value => {
        const div = document.createElement("div");
        div.className = "checkpoint cp-locked";
        div.dataset.value = String(value);

        const title = document.createElement("div");
        title.className = "checkpoint-title";
        title.textContent = formatCurrency(value) + "/m√™s";

        const status = document.createElement("div");
        status.className = "checkpoint-status";
        status.innerHTML = `<span>üîí</span><span>Aguardando respeito</span>`;

        div.appendChild(title);
        div.appendChild(status);
        container.appendChild(div);
      });
    }

    function updateCheckpointsUI(currentIncome) {
      const nodes = document.querySelectorAll(".checkpoint");
      let firstLockedFound = false;

      nodes.forEach(node => {
        const value = Number(node.dataset.value);
        const status = node.querySelector(".checkpoint-status");
        node.classList.remove("cp-unlocked", "cp-next", "cp-locked");

        if (currentIncome >= value) {
          node.classList.add("cp-unlocked");
          status.innerHTML = `<span>‚úÖ</span><span>Respeito consolidado</span>`;
        } else if (!firstLockedFound) {
          node.classList.add("cp-next");
          status.innerHTML = `<span>‚≠ê</span><span>Pr√≥ximo territ√≥rio</span>`;
          firstLockedFound = true;
        } else {
          node.classList.add("cp-locked");
          status.innerHTML = `<span>üîí</span><span>Ainda fora do alcance</span>`;
        }
      });
    }

    function buildRewards() {
      const container = document.getElementById("rewardsList");
      container.innerHTML = "";
      rewards.forEach(r => {
        const card = document.createElement("div");
        card.className = "reward-card reward-locked";
        card.dataset.value = String(r.value);

        const title = document.createElement("div");
        title.className = "reward-title";
        title.textContent = r.title;

        const tag = document.createElement("div");
        tag.className = "reward-tag";
        tag.textContent = r.tag;

        const quote = document.createElement("div");
        quote.className = "reward-quote";
        quote.textContent = `"${r.quote}"`;

        const status = document.createElement("div");
        status.className = "reward-status";
        status.innerHTML = `<span>üîí</span><span>Carta ainda n√£o desbloqueada</span>`;

        card.appendChild(title);
        card.appendChild(tag);
        card.appendChild(quote);
        card.appendChild(status);
        container.appendChild(card);

        card.addEventListener("click", () => {
          const currentIncome = Number(localStorage.getItem(STORAGE_KEYS.currentIncome) || 0);
          if (currentIncome >= r.value) openRewardModal(r);
          else showFeedback("rewardsFeedback", "Primeiro cruze esse checkpoint para ver o recado do Don.");
        });
      });
    }

    function updateRewardsUI(currentIncome) {
      const cards = document.querySelectorAll(".reward-card");
      cards.forEach(card => {
        const val = Number(card.dataset.value);
        const status = card.querySelector(".reward-status");
        card.classList.remove("reward-unlocked", "reward-locked");

        if (currentIncome >= val) {
          card.classList.add("reward-unlocked");
          status.innerHTML = `<span>‚úÖ</span><span>Carta desbloqueada</span>`;
        } else {
          card.classList.add("reward-locked");
          status.innerHTML = `<span>üîí</span><span>Carta ainda n√£o desbloqueada</span>`;
        }
      });
    }

    function openRewardModal(reward) {
      const modal = document.getElementById("rewardModal");
      document.getElementById("modalRewardTitle").textContent = reward.title;
      document.getElementById("modalRewardTag").textContent = reward.tag;
      document.getElementById("modalRewardQuote").textContent = `"${reward.quote}"`;
      document.getElementById("modalRewardDesc").textContent = reward.desc;
      modal.classList.add("open");
    }
    function closeRewardModal() { document.getElementById("rewardModal").classList.remove("open"); }

    function trackMaxIncomeAndNotify(currentIncome) {
      const prevMax = Number(localStorage.getItem(STORAGE_KEYS.maxIncomeEver) || 0);
      if (currentIncome > prevMax) {
        localStorage.setItem(STORAGE_KEYS.maxIncomeEver, String(currentIncome));
        let notified;
        try { notified = JSON.parse(localStorage.getItem(STORAGE_KEYS.rewardsNotified) || "[]"); }
        catch { notified = []; }
        if (!Array.isArray(notified)) notified = [];

        const newlyUnlocked = rewards.filter(r => currentIncome >= r.value && !notified.includes(r.value));
        if (newlyUnlocked.length > 0) {
          openRewardModal(newlyUnlocked[0]);
          notified.push(newlyUnlocked[0].value);
          localStorage.setItem(STORAGE_KEYS.rewardsNotified, JSON.stringify(notified));
        }
      }
    }

    function updateFinanceUI() {
      const targetIncome = Number(localStorage.getItem(STORAGE_KEYS.targetIncome) || 100000);
      const currentIncome = Number(localStorage.getItem(STORAGE_KEYS.currentIncome) || 0);

      document.getElementById("targetIncome").value = targetIncome;
      document.getElementById("currentIncome").value = currentIncome;

      let percent = 0;
      if (targetIncome > 0) percent = (currentIncome / targetIncome) * 100;
      percent = clamp(percent, 0, 999);

      document.getElementById("progressBarMain").style.width = percent + "%";
      document.getElementById("progressText").textContent = percent.toFixed(1) + "% do caminho";
      document.getElementById("progressValues").textContent = formatCurrency(currentIncome) + " / " + formatCurrency(targetIncome);

      const level = getLevel(percent);
      document.getElementById("levelName").textContent = level.name;
      document.getElementById("levelDescription").textContent = level.description;

      updateCheckpointsUI(currentIncome);
      updateRewardsUI(currentIncome);
      trackMaxIncomeAndNotify(currentIncome);
    }

    function saveFinanceLocal() {
      const targetIncome = Number(document.getElementById("targetIncome").value || 0);
      const currentIncome = Number(document.getElementById("currentIncome").value || 0);
      localStorage.setItem(STORAGE_KEYS.targetIncome, String(targetIncome));
      localStorage.setItem(STORAGE_KEYS.currentIncome, String(currentIncome));
      updateFinanceUI();
    }

    function saveMissionsLocal() {
      const container = document.getElementById("missionsList");
      const raw = container.dataset.missions;
      let missions = defaultMissions();
      try { missions = JSON.parse(raw); } catch {}

      const rows = container.querySelectorAll(".mission-row");
      rows.forEach(row => {
        const idx = Number(row.dataset.index);
        const checkbox = row.querySelector('input[type="checkbox"]');
        const textarea = row.querySelector('textarea');
        missions[idx] = { text: textarea.value || "", done: checkbox.checked };
      });

      localStorage.setItem(STORAGE_KEYS.missions, JSON.stringify(missions));
      renderMissions();
    }

    function resetFinanceLocal() {
      localStorage.removeItem(STORAGE_KEYS.targetIncome);
      localStorage.removeItem(STORAGE_KEYS.currentIncome);
      localStorage.removeItem(STORAGE_KEYS.maxIncomeEver);
      localStorage.removeItem(STORAGE_KEYS.rewardsNotified);
      updateFinanceUI();
    }

    function resetMissionsLocal() {
      localStorage.removeItem(STORAGE_KEYS.missions);
      renderMissions();
    }

    // ====== SUPABASE (Painel) ======
    function buildStateObject() {
      const targetIncome = Number(localStorage.getItem(STORAGE_KEYS.targetIncome) || 100000);
      const currentIncome = Number(localStorage.getItem(STORAGE_KEYS.currentIncome) || 0);
      const missions = loadMissionsLocal();
      const maxIncomeEver = Number(localStorage.getItem(STORAGE_KEYS.maxIncomeEver) || currentIncome);
      let rewardsNotified = [];
      try { rewardsNotified = JSON.parse(localStorage.getItem(STORAGE_KEYS.rewardsNotified) || "[]"); if (!Array.isArray(rewardsNotified)) rewardsNotified = []; }
      catch { rewardsNotified = []; }
      return { v: 1, targetIncome, currentIncome, missions, maxIncomeEver, rewardsNotified };
    }

    async function saveStateToSupabase() {
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return;
      const state = buildStateObject();
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/${SUPABASE_TABLE}`, {
          method: "POST",
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            "Content-Type": "application/json",
            Prefer: "resolution=merge-duplicates"
          },
          body: JSON.stringify({ id: SUPABASE_ROW_ID, state_json: state })
        });
      } catch (e) { console.error("Erro ao salvar no Supabase", e); }
    }

    async function loadStateFromSupabase() {
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) { updateFinanceUI(); renderMissions(); return; }
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/${SUPABASE_TABLE}?id=eq.${SUPABASE_ROW_ID}&select=state_json&limit=1`, {
          headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}`, "Content-Type": "application/json" }
        });
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0 && data[0].state_json) {
          const state = data[0].state_json;
          if (typeof state.targetIncome === "number") localStorage.setItem(STORAGE_KEYS.targetIncome, String(state.targetIncome));
          if (typeof state.currentIncome === "number") localStorage.setItem(STORAGE_KEYS.currentIncome, String(state.currentIncome));
          if (Array.isArray(state.missions)) localStorage.setItem(STORAGE_KEYS.missions, JSON.stringify(state.missions));
          if (typeof state.maxIncomeEver === "number") localStorage.setItem(STORAGE_KEYS.maxIncomeEver, String(state.maxIncomeEver));
          if (Array.isArray(state.rewardsNotified)) localStorage.setItem(STORAGE_KEYS.rewardsNotified, JSON.stringify(state.rewardsNotified));
        }
      } catch (e) { console.error("Erro ao carregar do Supabase", e); }

      updateFinanceUI();
      renderMissions();
    }

    /* =========================
       DESAFIO (Supabase normal, sem login)
       ========================= */
    const CHALLENGE_START = new Date(2026, 0, 11); // 11/01/2026 (m√™s 0 = janeiro)
    CHALLENGE_START.setHours(0,0,0,0);

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const challengeUser = { id: "desafio-180" };

    let challengeDays = {};        // { [day_number]: row }
    let selectedDay = null;
    let score = 3;

    let challengeInited = false;
    let ringMomentumChart, ringProgressChart, ringQualityChart, ringExecChart, lineScoresChart;

    function fmtDateBR(d){
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    function dateForDay(n){
      const d = new Date(CHALLENGE_START.getTime() + (n-1)*86400000);
      d.setHours(0,0,0,0);
      return d;
    }
    function todayNumber(){
      const today = new Date(); today.setHours(0,0,0,0);
      const diff = Math.round((today - CHALLENGE_START) / 86400000);
      return Math.min(180, Math.max(1, diff + 1));
    }

    function closeModal(){ document.getElementById("modal").style.display = "none"; }
    function openModal(){ document.getElementById("modal").style.display = "flex"; }
    function openToday(){ openDay(todayNumber()); }

    function openDay(n){
      selectedDay = n;
      score = Number(challengeDays[n]?.score ?? 3);

      document.getElementById("modalTitle").innerText = "Dia " + n;
      document.getElementById("modalDate").innerText  = fmtDateBR(dateForDay(n));

      renderStars();
      document.getElementById("did_create").checked = !!challengeDays[n]?.did_create_new;
      document.getElementById("note").value = challengeDays[n]?.created_note || "";

      openModal();
    }

    function renderStars(){
      const s = document.getElementById("stars");
      s.innerHTML = "";
      for(let i=1;i<=5;i++){
        const sp = document.createElement("span");
        sp.innerText = i <= score ? "‚òÖ" : "‚òÜ";
        sp.onclick = () => { score = i; renderStars(); };
        s.appendChild(sp);
      }
    }

    async function saveDay(){
      if(selectedDay == null) return;

      const payload = {
        user_id: challengeUser.id,
        day_number: selectedDay,
        day_date: dateForDay(selectedDay),
        score: Number(score),
        did_create_new: document.getElementById("did_create").checked,
        created_note: document.getElementById("note").value
      };

      const { error } = await sb
        .from("challenge_days")
        .upsert(payload, { onConflict: "user_id,day_number" });

      if(error){ alert("Erro ao salvar: " + error.message); return; }

      closeModal();
      await loadChallenge();
    }

    async function clearDay(){
      if(selectedDay == null) return;
      if(!confirm(`Apagar os dados do Dia ${selectedDay}?`)) return;

      const { error } = await sb
        .from("challenge_days")
        .delete()
        .eq("user_id", challengeUser.id)
        .eq("day_number", selectedDay);

      if(error){ alert("Erro ao apagar: " + error.message); return; }

      delete challengeDays[selectedDay];
      closeModal();
      await loadChallenge();
    }

    function calcStreak(){
      // streak de "Criei algo hoje" contando at√© hoje (retrocedendo)
      let t = todayNumber();
      let streak = 0;
      for(let i=t; i>=1; i--){
        const row = challengeDays[i];
        if(row && row.did_create_new) streak++;
        else break;
      }
      return streak;
    }

    function calcStats(){
      const entries = Object.values(challengeDays);
      const marked = entries.length;
      const greens = entries.filter(e => Number(e.score) >= 4).length;
      const created = entries.filter(e => !!e.did_create_new).length;

      const avg = marked ? (entries.reduce((a,e)=>a+Number(e.score||0),0)/marked) : 0;
      const greenPct = marked ? Math.round((greens/marked)*100) : 0;
      const createPct = marked ? Math.round((created/marked)*100) : 0;

      const last7 = [];
      const today = todayNumber();
      for(let i=Math.max(1, today-6); i<=today; i++){
        const s = challengeDays[i]?.score;
        last7.push(Number(s||0));
      }
      const momentum = last7.length ? Math.round((last7.filter(v=>v>=4).length/last7.length)*100) : 0;

      return { marked, greens, created, avg, greenPct, createPct, momentum };
    }

    function updateBadge(avg){
      const badge = document.getElementById("badgeStatus");
      const txt = document.getElementById("badgeText");
      badge.style.display = "inline-flex";

      if(avg >= 4.5) txt.innerText = "Elite em execu√ß√£o";
      else if(avg >= 4.0) txt.innerText = "Consist√™ncia forte";
      else if(avg >= 3.5) txt.innerText = "Ritmo em constru√ß√£o";
      else txt.innerText = "Recalibrar execu√ß√£o";
    }

    function renderGrid(){
      const g = document.getElementById("grid");
      g.innerHTML = "";
      let greensCount = 0;

      for(let i=1;i<=180;i++){
        const d = document.createElement("div");
        d.className = "day";
        d.innerText = i;

        const row = challengeDays[i];
        if(row){
          const sc = Number(row.score);
          if(sc >= 4){ d.classList.add("g"); greensCount++; }
          else if(sc === 3) d.classList.add("y");
          else d.classList.add("r");
        }

        d.onclick = () => openDay(i);
        g.appendChild(d);
      }

      document.getElementById("greens").innerText = greensCount;
    }

    function ensureCharts(){
      const ringCfg = (val) => ({
        type: "doughnut",
        data: { labels: ["ok","resto"], datasets: [{ data: [val, 100-val], borderWidth: 0 }] },
        options: { cutout: "75%", plugins: { legend: { display:false }, tooltip:{ enabled:false } } }
      });

      if(!ringMomentumChart){
        ringMomentumChart = new Chart(document.getElementById("ringMomentum"), ringCfg(0));
        ringProgressChart = new Chart(document.getElementById("ringProgress"), ringCfg(0));
        ringQualityChart  = new Chart(document.getElementById("ringQuality"),  ringCfg(0));
        ringExecChart     = new Chart(document.getElementById("ringExec"),     ringCfg(0));
      }

      if(!lineScoresChart){
        lineScoresChart = new Chart(document.getElementById("lineScores"), {
          type: "line",
          data: { labels: [], datasets: [{ label:"score", data: [], tension: .35, pointRadius: 2 }] },
          options: {
            plugins: { legend: { display:false } },
            scales: {
              y: { min: 0, max: 5, ticks: { stepSize: 1 } }
            }
          }
        });
      }
    }

    function setRing(chart, val){
      chart.data.datasets[0].data = [val, 100-val];
      chart.update();
    }

    function renderCharts(){
      ensureCharts();

      const today = todayNumber();
      const stats = calcStats();

      // texto
      document.getElementById("momenTxt").innerText = `${stats.momentum}%`;
      document.getElementById("progTxt").innerText  = `${Math.round((today/180)*100)}%`;
      document.getElementById("qualTxt").innerText  = `${Math.round((stats.avg/5)*100)}%`;
      document.getElementById("execTxt").innerText  = `${stats.marked ? Math.round((stats.marked/today)*100) : 0}%`;

      // rings
      setRing(ringMomentumChart, stats.momentum);
      setRing(ringProgressChart, Math.round((today/180)*100));
      setRing(ringQualityChart, Math.round((stats.avg/5)*100));
      setRing(ringExecChart, stats.marked ? Math.round((stats.marked/today)*100) : 0);

      // line (1..180, mas s√≥ preenchendo onde tem score)
      const labels = [];
      const values = [];
      for(let i=1;i<=today;i++){
        labels.push(i);
        values.push(challengeDays[i] ? Number(challengeDays[i].score||0) : null);
      }
      lineScoresChart.data.labels = labels;
      lineScoresChart.data.datasets[0].data = values;
      lineScoresChart.update();

      // right stats
      document.getElementById("daysMarked").innerText = String(stats.marked);
      document.getElementById("avgScore").innerText   = stats.marked ? stats.avg.toFixed(1) : "‚Äì";
      document.getElementById("greenPct").innerText   = stats.marked ? (stats.greenPct + "%") : "‚Äì";
      document.getElementById("createPct").innerText  = stats.marked ? (stats.createPct + "%") : "‚Äì";

      updateBadge(stats.avg);

      // left
      document.getElementById("dayNow").innerText = String(today);
      document.getElementById("streak").innerText = String(calcStreak());
    }

    async function loadChallenge(){
      // carrega s√≥ desse "usu√°rio fixo"
      const { data, error } = await sb
        .from("challenge_days")
        .select("*")
        .eq("user_id", challengeUser.id);

      if(error){ console.error(error); return; }

      challengeDays = {};
      (data || []).forEach(d => { challengeDays[d.day_number] = d; });

      renderGrid();
      renderCharts();
    }

    /* =========================
       TABS
       ========================= */
    function showSection(which){
      const painel  = document.getElementById("secPainel");
      const desafio = document.getElementById("secDesafio");
      const b1 = document.getElementById("tabPainel");
      const b2 = document.getElementById("tabDesafio");

      if(which === "painel"){
        painel.style.display = "block";
        desafio.style.display = "none";
        b1.classList.add("active");
        b2.classList.remove("active");
      } else {
        painel.style.display = "none";
        desafio.style.display = "block";
        b2.classList.add("active");
        b1.classList.remove("active");

        if(!challengeInited){
          challengeInited = true;
          loadChallenge();
        } else {
          loadChallenge();
        }
      }
    }

    /* =========================
       BOOT
       ========================= */
    document.addEventListener("DOMContentLoaded", () => {
      // Painel
      buildCheckpoints();
      buildRewards();
      loadStateFromSupabase();

      document.getElementById("saveFinance").addEventListener("click", async () => {
        saveFinanceLocal();
        await saveStateToSupabase();
        showFeedback("saveFeedback", "Tributo registrado e sincronizado com a fam√≠lia.");
      });

      document.getElementById("resetFinance").addEventListener("click", async () => {
        resetFinanceLocal();
        await saveStateToSupabase();
        showFeedback("saveFeedback", "Registros apagados e atualizados na nuvem.");
      });

      document.getElementById("saveMissions").addEventListener("click", async () => {
        saveMissionsLocal();
        await saveStateToSupabase();
        showFeedback("missionsFeedback", "Miss√µes registradas e sincronizadas.");
      });

      document.getElementById("resetMissions").addEventListener("click", async () => {
        resetMissionsLocal();
        await saveStateToSupabase();
        showFeedback("missionsFeedback", "Miss√µes apagadas em todos os dispositivos.");
      });

      document.getElementById("currentIncome").addEventListener("change", async () => {
        saveFinanceLocal();
        await saveStateToSupabase();
      });

      document.getElementById("targetIncome").addEventListener("change", async () => {
        saveFinanceLocal();
        await saveStateToSupabase();
      });

      document.getElementById("closeRewardModal").addEventListener("click", closeRewardModal);
      document.getElementById("rewardModal").addEventListener("click", (e) => {
        if (e.target.id === "rewardModal") closeRewardModal();
      });

      // Fechar modal desafio clicando fora
      document.getElementById("modal").addEventListener("click", (e) => {
        if(e.target.id === "modal") closeModal();
      });
    });
  </script>
</body>
</html>
